<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Registro INE con Firestore</title>

  <!-- ZXing para decodificar PDF417 -->
  <script src="https://unpkg.com/@zxing/library@0.19.1/umd/index.min.js"></script>
  <!-- Firebase App (core) -->
  <script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-app.js"></script>
  <!-- Firestore -->
  <script src="https://www.gstatic.com/firebasejs/10.2.0/firebase-firestore.js"></script>
  
  <style>
    body { font-family: sans-serif; max-width: 400px; margin: auto; padding: 1rem; }
    video { border: 1px solid #ccc; width: 100%; height: auto; }
    form { margin-top: 1rem; }
    label { display: block; margin: .5rem 0; }
    input[readonly] { background: #f9f9f9; }
    button { margin-top: .5rem; padding: .5rem 1rem; }
  </style>
</head>
<body>
  <h1>Registro INE</h1>

  <!-- 1) Vista de cámara -->
  <video id="video" autoplay muted></video>
  <button id="startCamera">Abrir cámara</button>
  <button id="scan">Escanear INE</button>

  <!-- 2) Formulario de datos -->
  <form id="form">
    <label>Nombre completo: <input type="text" id="nombre" readonly></label>
    <label>CURP:             <input type="text" id="curp" readonly></label>
    <label>Clave Elector:    <input type="text" id="clave" readonly></label>
    <hr>
    <label>Correo:           <input type="email" id="email" required></label>
    <label>Teléfono:         <input type="tel" id="telefono" required></label>
    <button type="submit">Guardar en Firestore</button>
  </form>

  <script>
    // --- Inicialización de Firebase ---
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      // resto de tu configuración...
    };
    const app = firebase.initializeApp(firebaseConfig);
    const db  = firebase.firestore(app);

    // --- ZXing para leer el PDF417 ---
    const codeReader = new ZXing.BrowserBarcodeReader();
    const video      = document.getElementById('video');

    document.getElementById('startCamera').addEventListener('click', async () => {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
        video.srcObject = stream;
      } catch (err) {
        alert('No se pudo acceder a la cámara: ' + err);
      }
    });

    document.getElementById('scan').addEventListener('click', async () => {
      try {
        const result = await codeReader.decodeOnceFromVideoDevice(undefined, video);
        const parts = result.text.split('|');
        // Ajusta índices si el formato difiere
        document.getElementById('curp')  .value = parts[1] || '';
        document.getElementById('nombre').value = (parts[3] + ' ' + parts[2]).trim();
        document.getElementById('clave') .value = parts[5] || '';
      } catch (e) {
        alert('No se detectó el código. Mejora la iluminación o acércate más.');
      }
    });

    // --- Guardar en Firestore ---
    document.getElementById('form').addEventListener('submit', async e => {
      e.preventDefault();
      const data = {
        nombre:   document.getElementById('nombre').value,
        curp:     document.getElementById('curp')  .value,
        clave:    document.getElementById('clave') .value,
        email:    document.getElementById('email') .value,
        telefono: document.getElementById('telefono').value,
        fecha:    firebase.firestore.Timestamp.now()
      };
      try {
        await db.collection('usuarios').add(data);
        alert('¡Registro guardado en Firestore!');
        // Opcional: limpiar formulario o redirigir
      } catch (err) {
        console.error(err);
        alert('Error al guardar en la base de datos.');
      }
    });
  </script>
</body>
</html>
